var spinner='<div class="spinner"><i class="spinner-icon"></i></div>';var calendar={ajaxurl:domain+"/calendar/",init:function(){this.loadListener();this.moveListener();this.dragable();this.dropable()},loadListener:function(){if($(".js-calendar").length>0){var cal=$(".js-calendar");var start=cal.data("start");var length=cal.data("length");calendar.getCalendar(start,length)}},moveListener:function(){$(".js-move-calendar").off("click").on("click",function(e){e.preventDefault();var start=$("#calendar").data("start");console.log(start);var length=$("#calendar").data("length");var move=$(this).data("move");calendar.getCalendar(start,length,move)})},dragable:function(){$(".dragable").off("dragstart").on("dragstart",function(event){event.originalEvent.dataTransfer.setData("text/html",this.outerHTML);event.originalEvent.dataTransfer.dropEffect="move"})},dropable:function(){$(".dropable").off("dragenter").on("dragenter",function(){$(this).addClass("lightgray").on("dragleave",function(){$(this).removeClass("lightgray")})});$(".dropable").off("dragover").on("dragover",function(event){event.preventDefault()});$(".dropable").off("drop").on("drop",function(event){event.preventDefault();var slot=$(this);slot.removeClass("lightgray");var data=event.originalEvent.dataTransfer.getData("text/html");var project_id=$(data).data("project");var date=slot.data("date");var user_id=slot.data("user");var busy=slot.data("busy");var length=1;var tasks=[];slot.children(".calendar-project").each(function(){tasks.push($(this).data("id"))});console.log(tasks);if(project_id>0){if(busy==1||tasks.length>1){alert("This day is already full.");slot.data("busy",1).removeClass("dropable")}else{if(tasks.length==1){length=.5;busy=1;if(team!==undefined){console.log("edit",tasks[0]);team.editTask(tasks[0],.5)}}if(team!==undefined){team.addTask(user_id,date,project_id,length,busy,slot);$(this).append(data)}}}else{if(tasks.length>0){alert("Delete projects first!")}else{var away=$(data).data("away");calendar.addAway(date,user_id,away,slot);$(this).append(data);console.log("away",away)}}})},getCalendar:function(start,length,move){$("#calendar").append(spinner);if(move!=undefined){var url=calendar.ajaxurl+start+"/"+length+"/"+move}else{var url=calendar.ajaxurl+start+"/"+length}$.ajax({url:url,data:{},error:function(){alert("error")},success:function(data){$("#calendar").html(data.html);$("#calendar").data("start",data.start);calendar.dropable()}})},addAway:function(date,user_id,away,slot){$.ajax({headers:{"X-CSRF-TOKEN":$('meta[name="csrf-token"]').attr("content")},url:calendar.ajaxurl+"away/add",method:"POST",data:{date:date,user:user_id,away:away},error:function(){slot.find('.vacation[data-away="'+away+'"]').remove();alert("Could not save task.")},success:function(data){if(data.result){slot.attr("data-busy","1").removeClass("dropable")}}})},delAway:function(id){$.ajax({headers:{"X-CSRF-TOKEN":$('meta[name="csrf-token"]').attr("content")},url:calendar.ajaxurl+"away/del/"+id,method:"DELETE",data:{date:date,user:user},error:function(){alert("Could not delete.")},success:function(data){if(data.result){var el=document.querySelector('.calendar-project[data-id="'+id+'"]');el.remove()}}})}};calendar.init();var team={ajaxurl:domain+"/admin/ajax/",init:function(){this.getClientByName()},getClientByName:function(){$("#client_search").autocomplete({source:this.ajaxurl+"clients/search",minLength:3,select:function(event,ui){$("#client_id-auto").val(ui.item.id);$("#client_name-auto").val(ui.item.name)},change:function(event,ui){$("#client_id-auto").val(ui.item?ui.item.id:"");$("#client_name-auto").val(ui.item?ui.item.name:"")}})},addTask:function(user_id,date,project_id,length,busy,slot){$.ajax({headers:{"X-CSRF-TOKEN":$('meta[name="csrf-token"]').attr("content")},url:team.ajaxurl+"calendar/new",method:"POST",data:{date:date,user_id:user_id,project_id:project_id,length:length},error:function(){slot.find('.calendar-project[data-project="'+project_id+'"]').remove();alert("Error: Could not save task.")},success:function(data){if(data.result){if(busy){slot.attr("data-busy","1").removeClass("dropable")}slot.find('.calendar-project[data-project="'+project_id+'"]').attr("data-length",length);slot.find('.calendar-project[data-project="'+project_id+'"]').attr("data-id",data.id)}else{slot.find('.calendar-project[data-project="'+project_id+'"]').remove();alert("Could not save task.")}}})},editTask:function(id,length){$.ajax({headers:{"X-CSRF-TOKEN":$('meta[name="csrf-token"]').attr("content")},url:team.ajaxurl+"calendar/edit/"+id,method:"PUT",data:{length:length},error:function(){alert("Could not save.")},success:function(data){if(data.result){el=document.querySelector('.calendar-project[data-id="'+id+'"]');el.dataset.length=length}}})},delTask:function(id){$.ajax({headers:{"X-CSRF-TOKEN":$('meta[name="csrf-token"]').attr("content")},url:team.ajaxurl+"calendar/del/"+id,method:"DELETE",data:{},error:function(){alert("Could not delete.")},success:function(data){el=document.querySelector('.calendar-project[data-id="'+id+'"]');el.remove()}})}};team.init();